---
title: "Results & Strategic Analysis"
jupyter: python3
---

# 1. Financial Impact Analysis

We compare the **Historical Strategy** (what actually happened) against our **Optimized Strategy** (what the model recommends).

```{python}
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# Set visual style
sns.set_theme(style="whitegrid")

# --- LOAD RESULTS ---
try:
    df = pd.read_csv('data/results.csv')
    
    # SAFETY CHECK: Map column names automatically to avoid KeyErrors
    # This checks if you used 'Avg_Price' or 'Price_Unit'
    col_map = {
        'Price': 'Avg_Price' if 'Avg_Price' in df.columns else 'Price_Unit',
        'Weight': 'Avg_Weight' if 'Avg_Weight' in df.columns else 'Weight_Unit'
    }
    
    print(f"Detected columns: Price column = '{col_map['Price']}', Weight column = '{col_map['Weight']}'")

except FileNotFoundError:
    print("Error: 'data/results.csv' not found. Run '02_model.qmd' first.")

# --- CALCULATE IMPACT ---

# 1. Historical Revenue (Sum of Demand * Price)
hist_revenue = (df['Original_Demand'] * df[col_map['Price']]).sum()

# 2. Optimized Strategy (Sum of Optimized Qty * Price)
opt_revenue = (df['Optimized_Qty'] * df[col_map['Price']]).sum()

# 3. Naive Baseline (Just cutting everything by 30%)
# Use 0.7 if you used 70% capacity in your model
scale_factor = 0.7 
naive_revenue = (df['Original_Demand'] * scale_factor * df[col_map['Price']]).sum()

# Calculate Improvement over a Naive cut
improvement = opt_revenue - naive_revenue
pct_gain = (improvement / naive_revenue) * 100

print("-" * 30)
print(f"Naive Strategy Revenue:   R$ {naive_revenue:,.2f}")
print(f"Optimized Strategy Revenue: R$ {opt_revenue:,.2f}")
print(f"Optimization Value-Add:     R$ {improvement:,.2f} (+{pct_gain:.2f}% improvement)")
print("-" * 30)
```
# The Optimization Strategy
## A. Categories Deprioritized

```{python}
df['Reduction'] = df['Original_Demand'] - df['Optimized_Qty']
losers = df[df['Reduction'] > 0].sort_values(col_map['Weight'], ascending=False).head(5)

print("\n--- TOP 5 CATEGORIES TO REDUCE ---")
print(losers[['Category', col_map['Weight'], col_map['Price'], 'Reduction']])

```

## B. Categories Prioritized 
```{python}
winners = df[df['Status'] == 'Full Demand Met'].sort_values(col_map['Price'], ascending=False).head(5)

print("--- TOP 5 CATEGORIES TO PRIORITIZE ---")
print(winners[['Category', col_map['Weight'], col_map['Price']]])
```

# 3. Visualization

```{python}
#| label: fig-comparison
#| fig-cap: "Revenue Comparison: Optimized Prioritization vs. Naive Percentage Cut"

revenue_data = pd.DataFrame({
    'Strategy': ['Naive Cut (Flat 30%)', 'Optimized Strategy (Simplex)'],
    'Revenue': [naive_revenue, opt_revenue]
})

plt.figure(figsize=(10, 6))
ax = sns.barplot(data=revenue_data, x='Strategy', y='Revenue', palette=['#95a5a6', '#2ecc71'])
plt.title('Why Optimize? Revenue with 30% Capacity Reduction', fontsize=14)
plt.ylabel('Total Revenue (R$)')

# Add values on top of bars
for p in ax.patches:
    ax.annotate(f'R$ {p.get_height():,.0f}', 
                (p.get_x() + p.get_width() / 2., p.get_height()), 
                ha='center', va='center', xytext=(0, 10), textcoords='offset points', fontweight='bold')

plt.ylim(0, opt_revenue * 1.2) # Give some space at the top
plt.show()

```